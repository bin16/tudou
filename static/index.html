<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tudou Paper</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <style>
    :root {
      --primary-color: teal;
      /* --secondary-color: darkgray; */
      --danger-color: red;
      --border-color: #bbb;
      --text-color: #333;
      --tab-color: #eee;
      --tab-hover-color: #f9f9f9;
      --tab-active-color: #fff;
      --font-mono: 'Courier New', Courier, monospace;
      --font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --font-serif: Georgia, 'Times New Roman', Times, serif;
    }
    html {
      color: var(--text-color);
      font-family: var(--font-sans-serif);
    }
    .paper {
      margin: 2rem auto;
      width: 640px;
      padding: 0rem;
      box-shadow: 2px 2px 5px var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }
    .paper-tabs {
      display: flex;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--tab-active-color);
    }
    .paper-tab {
      padding: .5rem;
      font: .8rem/1rem var(--font-sans-serif);
      color: #999;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      background-color: var(--tab-color);
    }
    .paper-tab--active {
      color: var(--text-color);
      border-bottom: none;
      background-color: var(--tab-active-color);
      box-shadow: 0 2px 0 var(--primary-color) inset;
    }
    .paper-tab:last-child {
      border-right: none;
    }
    .paper-tab:not(.paper-tab--active) {
      background-color: var(--tab-hover-color);
    }
    .paper-tab,
    .paper-tab > a {
      color: #999;
      text-decoration: none;
      user-select: none;
    }
    .paper-tab--active,
    .paper-tab--active > a {
      color: var(--text-color);
    }
    .todo-list {
      display: block;
      margin: 0;
      height: 720px;
      padding: 0;
      overflow-y: auto;
    }
    .todo {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      list-style-type: none;
      border-bottom: 1px solid var(--border-color);
    }
    .todo:last-child {
      /* border-bottom: none; */
    }
    .todo-icon {
      width: 3rem;
      padding: 1rem 0;
      text-align: center;
      user-select: none;
    }
    .todo-tag {
      width: 4px;
      border-left: 1px solid var(--primary-color);
      border-right: 1px solid var(--primary-color);
    }
    .todo-content {
      padding: 0 1rem;
    }
    .todo-text {
      display: block;
      padding: 1rem 0;
      font: .85rem / 1.2 var(--font-serif);
      white-space: pre-line;
    }
    .todo--not-open .todo-text {
      color: #888;
      text-decoration: line-through;
    }
    .todo-action-group {
      font-size: .8rem;
      /* margin-bottom: .2rem; */
      display: flex;
      justify-content: flex-start;
    }
    .todo-action {
      display: inline-block;
      padding: 0 .2rem;
      font-size: .8rem;
      color: #888;
      text-decoration: none;
    }
    .todo-action:first-child {
      padding-left: 0;
    }
    .todo-action:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }
    .todo-action-group-wrapper {
      display: inline-flex;
      align-items: center;
      float: right;
      height: 3rem;
      padding-left: 1rem;
      clear: both;
    }


    .hover-color-primary:hover {
      color: var(--primary-color);
    }
    .hover-color-danger:hover {
      color: var(--danger-color);
    }
    .hover-color-secondary:hover {
      color: var(--secondary-color);
    }
    .flex-row {
      display: flex;
    }
    .flex-fill {
      flex: 1;
    }
    .justify-content-end {
      justify-content: flex-end;
    }

    .font-mono {
      font-family: var(--font-mono);
    }
    .font-sans-serif {
      font-family: var(--font-sans-serif);
    }
    .font-serif {
      font-family: var(--font-serif);
    }
    .icon {
      display: block;
      margin: auto;
      width: 1rem;
      height: 1rem;
      background-repeat: no-repeat;
      background-position: center;
      opacity: .5;
    }
    .icon--2x {
      transform: scale(2);
    }
    .icon--3x {
      transform: scale(3);
    }
    .icon--finished {
      background-image: url(/icon-finished.svg);
    }
    .icon--canceled {
      background-image: url(/icon-canceled.svg);
    }
    .icon--postponed {
      background-image: url(/icon-postponed.svg);
    }

    .paper-container {
      padding: 1rem;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="paper">
      <div class="paper-tabs">
        <div class="paper-tab tab-tudou" :class="view === TudouView && 'paper-tab--active'">
          <a @click="changeView(TudouView)" href="javascript:;">Tudou Paper</a>
        </div>
        <div class="paper-tab tab-overdue" :class="view === OverdueView && 'paper-tab--active'">
          <a @click="changeView(OverdueView)" href="javascript:;">Overdue</a>
        </div>
        <div class="paper-tab tab-today" :class="view === TodayView && 'paper-tab--active'">
          <a @click="changeView(TodayView)" href="javascript:;">Today</a>
        </div>
        <div class="paper-tab tab-tomorraw" :class="view === TomorrawView && 'paper-tab--active'">
          <a @click="changeView(TomorrawView)" href="javascript:;">Tomorraw</a>
        </div>
        <div class="paper-tab flex-fill"></div>
        <div class="paper-tab tab-settings" :class="view === SettingsView && 'paper-tab--active'">
          <a @click="changeView(SettingsView)" href="javascript:;">Settings</a>
        </div>
        <div class="paper-tab tab-profile" :class="view === ProfileView && 'paper-tab--active'">
          <a @click="changeView(ProfileView)" href="javascript:;">{{ user.name }} ({{ user.coins }}üí∞)</a>
        </div>
      </div>
      <today-view :todos="todayTodos" v-show="view === TodayView"></today-view>
      <tomorraw-view :todos="tomorrawTodos" v-show="view === TomorrawView"></tomorraw-view>
      <overdue-view :todos="overdueTodos" v-show="view === OverdueView"></overdue-view>
      <settings-view v-show="view === SettingsView"></settings-view>
      <profile-view v-show="view === ProfileView"></profile-view>
      <tudou-view v-show="view === TudouView"></tudou-view>
    </div>
  </div>
  <template id="todo-item-template">
    <li class="todo" :class="todo.status == 'todo_open' ? 'todo--open' : 'todo--not-open'">
      <div class="todo-icon">
        <span v-show="todo.status == 'todo_open'"></span>
        <span v-show="todo.status == 'todo_finished'">
          <i class="icon icon--2x icon--finished"></i>
        </span>
        <span v-show="todo.status == 'todo_postponed'">
          <i class="icon icon--2x icon--postponed"></i>
        </span>
        <span v-show="todo.status == 'todo_canceled'">
          <i class="icon icon--2x icon--canceled"></i>
        </span>
      </div>
      <div class="todo-tag">
        
      </div>
      <div class="todo-content flex-fill">
        <div class="todo-action-group-wrapper">
          <slot name="action-group" v-bind:todo="todo"></slot>
        </div>
        <span class="todo-text">{{ todo.event.content }}</span>
        <slot></slot>
      </div>
    </li>
  </template>
  <template id="todo-list-template">
    <ul class="todo-list">
      <slot></slot>
    </ul>
  </template>
  <template id="today-view-template">
    <todo-list>
      <todo-item  
        :todo="todo" 
        :finishTodo="finishTodo"
        :key="todo.id" v-for="todo in todos">
        <template v-slot:action-group="slotProps" >
          <div :key="slotProps.todo.id" class="todo-action-group" v-show="slotProps.todo.status == 'todo_open'">
            <a @click="finishTodo(slotProps.todo)" class="todo-action hover-color-primary" href="javascript:;">ÂÆåÊàê</a>
            <a @click="pushTodo(slotProps.todo)" class="todo-action hover-color-secondary" href="javascript:;">ÊòéÂ§©</a>
            <a @click="editTodo(slotProps.todo)" class="todo-action hover-color-secondary" href="javascript:;">ÁºñËæë</a>
            <a @click="cancelTodo(slotProps.todo)" class="todo-action hover-color-danger" href="javascript:;">ÂèñÊ∂à</a>
          </div>
        </template>
      </todo-item>
    </todo-list>
  </template>
  <template id="tomorraw-view-template">
    <todo-list>
      <todo-item :key="todo.id" :todo="todo" v-for="todo in todos">
        <template v-slot:action-group="slotProps" >
          <div :key="slotProps.todo.id" class="todo-action-group" v-show="slotProps.todo.status == 'todo_open'">
            <a @click="pullTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">‰ªäÂ§©</a>
            <a @click="editTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">ÁºñËæë</a>
            <a @click="cancelTodo(todo)" class="todo-action hover-color-danger" href="javascript:;">ÂèñÊ∂à</a>
          </div>
        </template>
      </todo-item>
    </todo-list> 
  </template>
  <template id="overdue-view-template">
    <todo-list>
      <todo-item :key="todo.id" :todo="todo" v-for="todo in todos">
        <template v-slot:action-group="slotProps" >
          <div :key="slotProps.todo.id" class="todo-action-group" v-show="slotProps.todo.status == 'todo_open'">
            <a @click="renewTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">Êõ¥Êñ∞</a>
          </div>
        </template>
      </todo-item>
    </todo-list>  
  </template>
  <template id="settings-view-template">
    <div class="paper-container">
      <span class="font-mono">Settings</span>
    </div>
  </template>
  <template id="profile-view-template">
    <div class="paper-container">
      <span class="font-mono">Profile</span>
    </div>
  </template>
  <template id="tudou-view-template">
    <div class="paper-container">
      <pre>

        Tudou Paper v0.1
        ================================================

        Thanks

        * Gin         https://gin-gonic.com/
                      https://github.com/gin-gonic/gin

        * Gorm        https://gorm.io/
                      https://github.com/jinzhu/gorm

        * Vue.js      https://vuejs.org
                      https://github.com/vuejs/vue

        * Cloudflare  https://cloudflare.com
        ================================================
      </pre>
    </div>
  </template>
  <script>
    (function () {
      window.addEventListener('DOMContentLoaded', function() {
        const TudouView = 'tudou-view';
        const TodayView = 'today-view';
        const TomorrawView = 'tomorraw-view';
        const OverdueView = 'overdue-view';
        const SettingsView = 'settings-view';
        const ProfileView = 'profile-view';
        const EventBus = new Vue();
        Vue.mixin({
          methods: {
            reload: () => EventBus.$emit('changed'),
          },
        });
        Vue.component('todo-list', {
          template: '#todo-list-template',
          props: ['todos'],
        });
        Vue.component('todo-item', {
          template: '#todo-item-template',
          props: ['todo'],
          methods: {
            hello() {
              console.log('Hello World!');
            }
          },
        });
        Vue.component('today-view', {
          template: '#today-view-template',
          props: ['todos'],
          methods: {
            async pushTodo(todo) {
              await pushTodo(todo.id);
              await this.reload();
            },
            async finishTodo(todo) {
              await finishTodo(todo.id);
              await this.reload();
            },
            async cancelTodo(todo) {
              await cancelTodo(todo.id);
              await this.reload();
            },
          },
        });
        Vue.component('tomorraw-view', {
          template: '#tomorraw-view-template',
          props: ['todos'],
          methods: {
            async pullTodo(todo) {
              await pullTodo(todo.id);
              await this.reload();
            },
            async cancelTodo(todo) {
              await cancelTodo(todo.id);
              await this.reload();
            },
          }
        });
        Vue.component('overdue-view', {
          template: '#overdue-view-template',
          props: ['todos'],
          methods: {
            async renewTodo(todo) {
              await renewTodo(todo.id);
              await this.reload();
            },
          },
        });
        Vue.component('settings-view', {
          template: '#settings-view-template',
        });
        Vue.component('profile-view', {
          template: '#profile-view-template',
        });
        Vue.component('tudou-view', {
          template: '#tudou-view-template',
        });
        new Vue({
          el: '#app',
          data: {
            user: {},
            todayTodos: [],
            tomorrawTodos: [],
            overdueTodos: [],

            view: TodayView,
            TudouView,
            TodayView,
            TomorrawView,
            OverdueView,
            SettingsView,
            ProfileView,
          },
          created() {
            this.reload();
            EventBus.$on('changed', () => {
              this.reload();
            });
          },
          methods: {
            changeView(viewName) {
              this.view = viewName;
            },
            reload() {
              this.getTodos();
              this.getProfile();
            },
            async getTodos() {
              const { todayTodos, tomorrawTodos, overdueTodos, } = await getTodos();
              this.todayTodos = todayTodos;
              this.tomorrawTodos = tomorrawTodos;
              this.overdueTodos = overdueTodos;
            },
            async getProfile() {
              const user = await getProfile();
              this.user = user;
              this.settings = user.settings || {};
            },
            async createTodo() {
              const { content } = this.form;
              await createTodo(content);
              await this.reload();
              await this.resetForm();
            },
            async updateTodo() {
              const { id, content } = this.form;
              await updateTodo(id, content);
              await this.reload();
              await this.resetForm();
            },
            // async removeTodo(todo) {
            //   await removeTodo(todo.id);
            //   await this.reload();
            // },
          },
        });
      });
      async function getTodos() {
        const resp = await fetch('/api/my/todos');
        const data = await resp.json();
        const {
          today,
          tomorraw,
        } = data;
        const todayTodos = data[today];
        const tomorrawTodos = data[tomorraw];
        const overdueTodos = data['overdue'];
      
        return {
          today,
          todayTodos,
          tomorraw,
          tomorrawTodos,
          overdueTodos,
        };
      }
      async function getProfile() {
        const resp = await fetch('/api/my/profile');
        const data = await resp.json();
        const { user } = data;
        return user;
      }
      async function createTodo(content) {
        const resp = await fetch('/api/a/todo.create', {
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content, }),
          method: 'POST',
        });
      }
      async function updateTodo(id, content) {
        const resp = await fetch('/api/a/todo.update', {
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id, content, }),
          method: 'POST',
        });
      }
      async function pullTodo(id) {
        const resp = await fetch(`/api/a/todo.pull?id=${id}`, {
          method: 'POST',
        });
      }
      async function pushTodo(id) {
        const resp = await fetch(`/api/a/todo.push?id=${id}`, {
          method: 'POST',
        });
      }
      async function cancelTodo(id) {
        const resp = await fetch(`/api/a/todo.cancel?id=${id}`, {
          method: 'POST',
        });
      }
      async function finishTodo(id) {
        const resp = await fetch(`/api/a/todo.finish?id=${id}`, {
          method: 'POST',
        });
      }
      async function removeTodo(id) {
        const resp = await fetch(`/api/a/todo.remove?id=${id}`, {
          method: 'POST',
        });
      }
      async function renewTodo(id) {
        const resp = await fetch(`/api/a/todo.renew?id=${id}`, {
          method: 'POST',
        });
      }
    })();
  </script>
</body>

</html>