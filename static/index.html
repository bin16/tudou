<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tudou Paper</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <style>
    :root {
      --primary-color: teal;
      --danger-color: red;
      --border-color: #bbb;
      --text-color: #333;
      --tab-color: #eee;
      --tab-hover-color: #f9f9f9;
      --tab-active-color: #fff;
      --font-mono: 'Courier New', Courier, monospace;
      --font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --font-serif: Georgia, 'Times New Roman', Times, serif;
    }
    html {
      color: var(--text-color);
      font-family: var(--font-sans-serif);
    }
    .paper {
      margin: 2rem auto;
      width: 640px;
      padding: 0rem;
      box-shadow: 2px 2px 5px var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }
    .paper-tabs {
      display: flex;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--tab-active-color);
    }
    .paper-tab {
      padding: .5rem;
      font: .8rem/1rem var(--font-sans-serif);
      color: #999;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      background-color: var(--tab-color);
    }
    .paper-tab--active {
      color: var(--text-color);
      border-bottom: none;
      background-color: var(--tab-active-color);
      box-shadow: 0 2px 0 var(--primary-color) inset;
    }
    .paper-tab:last-child {
      border-right: none;
    }
    .paper-tab:not(.paper-tab--active) {
      background-color: var(--tab-hover-color);
    }
    .paper-tab,
    .paper-tab > a {
      color: #999;
      text-decoration: none;
      user-select: none;
    }
    .paper-tab--active,
    .paper-tab--active > a {
      color: var(--text-color);
    }
    .todo-list {
      display: block;
      margin: 0;
      height: 720px;
      padding: 0;
      overflow-y: auto;
    }
    .todo {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      list-style-type: none;
      border-bottom: 1px solid var(--border-color);
    }
    .todo:last-child {
      /* border-bottom: none; */
    }
    .todo-icon {
      width: 3rem;
      padding: 1em 0;
      text-align: center;
      user-select: none;
    }
    .todo-icon .bi {
      transform: scale(1.5);
    }
    .todo-tag {
      width: 4px;
      border-left: 1px solid var(--primary-color);
      border-right: 1px solid var(--primary-color);
    }
    .todo-content {
      padding: 0 1rem;
    }
    .todo-text {
      display: block;
      padding: 1rem 0;
      font: .85rem / 1.2 var(--font-serif);
      white-space: pre-line;
    }
    .todo--not-open .todo-text {
      color: #888;
      text-decoration: line-through;
    }
    .todo-text textarea {
      width: calc(100% - 120px);
      border: 1px solid var(--border-color);
      height: 6rem;
      padding: .5rem .5rem 1rem;
      resize: vertical;
    }
    .todo-text textarea:focus {
      outline: 1px solid var(--primary-color);
    }
    .todo-action-group {
      font-size: .8rem;
      /* margin-bottom: .2rem; */
      display: flex;
      justify-content: flex-start;
    }
    .todo-action {
      display: inline-block;
      padding: 0 .2rem;
      font-size: .8rem;
      color: #888;
      text-decoration: none;
    }
    .todo-action:first-child {
      padding-left: 0;
    }
    .todo-action:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }
    .todo-action-group-wrapper {
      display: inline-flex;
      align-items: center;
      float: right;
      height: 3rem;
      padding-left: 1rem;
      clear: both;
    }


    .hover-color-primary:hover {
      color: var(--primary-color);
    }
    .hover-color-danger:hover {
      color: var(--danger-color);
    }
    .hover-color-secondary:hover {
      color: var(--secondary-color);
    }
    .flex-row {
      display: flex;
    }
    .flex-fill {
      flex: 1;
    }
    .justify-content-end {
      justify-content: flex-end;
    }

    .font-mono {
      font-family: var(--font-mono);
    }
    .font-sans-serif {
      font-family: var(--font-sans-serif);
    }
    .font-serif {
      font-family: var(--font-serif);
    }
    .icon {
      display: block;
      margin: auto;
      width: 1rem;
      height: 1rem;
      background-repeat: no-repeat;
      background-position: center;
      opacity: .5;
    }
    .icon--2x {
      transform: scale(2);
    }
    .icon--3x {
      transform: scale(3);
    }
    .icon--finished {
      background-image: url(/icon-finished.svg);
    }
    .icon--canceled {
      background-image: url(/icon-canceled.svg);
    }
    .icon--postponed {
      background-image: url(/icon-postponed.svg);
    }

    .paper-container {
      padding: 1rem;
    }

    .icon-checked,
    .icon-arrow-right,
    .icon-cross {
      position: relative;
      display: inline-block;
      width: 1em;
      height: 1em;
      font-size: 1rem;
    }
    .icon-checked::before {
      content: '';
      box-sizing: border-box;
      display: block;
      width: 1.2em;
      height: .7em;
      border-left: .25em solid #000;
      border-bottom: .25em solid #000;
      transform-origin: center;
      transform: rotate(-45deg);
    }
    .icon-arrow-right::before {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      box-sizing: border-box;
      display: block;
      width: 100%;
      height: 100%;
      border-top: .25em solid #000;
      border-right: .25em solid #000;
      transform-origin: center;
      transform: rotate(45deg);
    }
    .icon-arrow-right::after {
      content: '';
      position: absolute;
      top: .375em;
      right: .15rem;
      box-sizing: border-box;
      width: 1em;
      height: .25em;
      background-color: black;
    }
    .icon-cross::before,
    .icon-cross::after {
      content: '';
      position: absolute;
      left: .25em;
      top: -.1em;
      display: block;
      width: .25em;
      height: 1.2em;
      background-color: black;
    }
    .icon-cross::before {
      transform: rotate(45deg);
    }
    .icon-cross::after {
      transform: rotate(-45deg);
    }

    .td-form,
    .td-form-item,
    .td-form label,
    .td-form input,
    .td-form select {
      display: block;
    }
    .td-form label {
      padding-bottom: .25rem;
    }
    .td-form-item {
      padding: .5rem 0;
    }
    .td-form input,
    .td-form select {
      box-sizing: border-box;
      width: 100%;
      height: 40px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      padding: 0 .5rem;
    }
    .td-form input:focus,
    .td-form select:focus {
      outline: 3px solid var(--primary-color);
    }
    .td-button {
      padding: .5rem 1rem;
      border: 1px solid var(--border-color);
      background-color: var(--tab-color);
      cursor: pointer;
      color: var(--text-color);
    }
    .td-button:hover {
      color: var(--text-color);
      background-color: var(--tab-hover-color);
    }
    .td-button:active {
      color: var(--primary-color);
      background-color: var(--tab-active-color);
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="paper">
      <div class="paper-tabs">
        <div class="paper-tab tab-tudou" :class="view === TudouView && 'paper-tab--active'">
          <a @click="navigate(TudouView)" href="javascript:;">Tudou Paper</a>
        </div>
        <div class="paper-tab tab-overdue" :class="view === OverdueView && 'paper-tab--active'">
          <a @click="navigate(OverdueView)" href="javascript:;">Overdue</a>
        </div>
        <div class="paper-tab tab-today" :class="view === TodayView && 'paper-tab--active'">
          <a @click="navigate(TodayView)" href="javascript:;">Today</a>
        </div>
        <div class="paper-tab tab-tomorraw" :class="view === TomorrawView && 'paper-tab--active'">
          <a @click="navigate(TomorrawView)" href="javascript:;">Tomorraw</a>
        </div>
        <div class="paper-tab flex-fill"></div>
        <div class="paper-tab tab-settings" :class="view === SettingsView && 'paper-tab--active'">
          <a @click="navigate(SettingsView)" href="javascript:;">Settings</a>
        </div>
        <div class="paper-tab tab-profile" :class="view === ProfileView && 'paper-tab--active'">
          <a @click="navigate(ProfileView)" href="javascript:;">{{ user.name }} ({{ user.coins }}💰)</a>
        </div>
      </div>
      <today-view :todos="todayTodos" v-show="view === TodayView"></today-view>
      <tomorraw-view :todos="tomorrawTodos" v-show="view === TomorrawView"></tomorraw-view>
      <overdue-view :todos="overdueTodos" v-show="view === OverdueView"></overdue-view>
      <settings-view v-show="view === SettingsView"></settings-view>
      <profile-view v-show="view === ProfileView"></profile-view>
      <tudou-view v-show="view === TudouView"></tudou-view>
    </div>
  </div>
  <template id="todo-item-template">
    <li class="todo" :class="todo.status == 'todo_open' ? 'todo--open' : 'todo--not-open'">
      <div class="todo-icon">
        <span v-if="todo.status == 'todo_open'"></span>
        <span v-else-if="todo.status == 'todo_finished'">
          <!-- <i class="icon icon--2x icon--finished"></i> -->
          <!-- <i class="icon-checked"></i> -->
          <icon-check></icon-check>
        </span>
        <span v-else-if="todo.status == 'todo_postponed'">
          <!-- <i class="icon icon--2x icon--postponed"></i> -->
          <!-- <i class="icon-arrow-right"></i> -->
          <icon-right></icon-right>
        </span>
        <span v-else="todo.status == 'todo_canceled'">
          <!-- <i class="icon icon--2x icon--canceled"></i> -->
          <!-- <i class="icon-cross"></i> -->
          <icon-dash></icon-dash>
        </span>
      </div>
      <div class="todo-tag">
        
      </div>
      <div class="todo-content flex-fill" >
        <div class="todo-action-group-wrapper">
          <slot name="action-group" v-bind:todo="todo"></slot>
        </div>
        <span class="todo-text">{{ todo.event.content }}</span>
      </div>
    </li>
  </template>
  <template id="todo-list-template">
    <ul class="todo-list">
      <slot></slot>
    </ul>
  </template>
  <template id="today-view-template">
    <todo-list>
      <template v-for="todo in todos">
        <li class="todo todo-form" v-if="form.id === todo.id">
          <div class="todo-icon"></div>
          <div class="todo-tag"></div>
          <div class="todo-content flex-fill">
            <div class="todo-action-group-wrapper">
              <div class="todo-action-group">
                <a @click="updateTodo" class="todo-action hover-color-primary" href="javascript:;">保存</a>
                <a @click="resetForm" class="todo-action hover-color-danger" href="javascript:;">取消</a>
              </div>
            </div>
            <span class="todo-text">
              <textarea v-model="form.content">{{ todo.event.content }}</textarea>
            </span>
          </div>
        </li>
        <todo-item  
          :todo="todo" 
          :key="todo.id" v-else>
          <template v-slot:action-group="slotProps" >
            <div :key="slotProps.todo.id" class="todo-action-group" v-if="slotProps.todo.status == 'todo_open'">
              <a @click="finishTodo(slotProps.todo)" class="todo-action hover-color-primary" href="javascript:;">完成</a>
              <a @click="pushTodo(slotProps.todo)" class="todo-action hover-color-secondary" href="javascript:;">明天</a>
              <a @click="editTodo(slotProps.todo)" class="todo-action hover-color-secondary" href="javascript:;">编辑</a>
              <a @click="cancelTodo(slotProps.todo)" class="todo-action hover-color-danger" href="javascript:;">取消</a>
            </div>
            <div :key="slotProps.todo.id" class="todo-action-group" v-else>
              <a @click="cloneTodo(slotProps.todo)" class="todo-action hover-color-secondary" href="javascript:;">复制</a>
            </div>
          </template>
        </todo-item>
      </template>
    </todo-list>
  </template>
  <template id="tomorraw-view-template">
    <todo-list>
      <template v-for="todo in todos">
        <li class="todo todo-form" v-if="form.id === todo.id">
          <div class="todo-icon"></div>
          <div class="todo-tag"></div>
          <div class="todo-content flex-fill">
            <div class="todo-action-group-wrapper">
              <div class="todo-action-group">
                <a @click="updateTodo" class="todo-action hover-color-primary" href="javascript:;">保存</a>
                <a @click="resetForm" class="todo-action hover-color-danger" href="javascript:;">取消</a>
              </div>
            </div>
            <span class="todo-text">
              <textarea v-model="form.content">{{ todo.event.content }}</textarea>
            </span>
          </div>
        </li>
        <todo-item  
          :todo="todo" 
          :key="todo.id" v-else>
          <template v-slot:action-group="slotProps" >
            <div :key="slotProps.todo.id" class="todo-action-group" v-show="slotProps.todo.status == 'todo_open'">
              <a @click="pullTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">今天</a>
              <a @click="editTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">编辑</a>
              <a @click="cancelTodo(todo)" class="todo-action hover-color-danger" href="javascript:;">取消</a>
              <a @click="removeTodo(todo)" class="todo-action hover-color-danger" href="javascript:;">删除</a>
            </div>
          </template>
        </todo-item>
      </template>
      <div class="todo form" v-show="!form.id">
        <div class="todo-icon"></div>
        <div class="todo-tag"></div>
        <div class="todo-content flex-fill">
          <div class="todo-action-group-wrapper">
            <div class="todo-action-group">
              <a @click="createTodo" href="javascript:;" class="todo-action hover-color-primary">创建</a>
              <a @click="resetForm" href="javascript:;" class="todo-action hover-color-primary">取消</a>
            </div>
          </div>
          <span class="todo-text">
            <textarea v-model="form.content">
              Hello World!
            </textarea>
          </span>
        </div>
      </div>
    </todo-list>
  </template>
  <template id="overdue-view-template">
    <todo-list>
      <todo-item :key="todo.id" :todo="todo" v-for="todo in todos">
        <template v-slot:action-group="slotProps" >
          <div :key="slotProps.todo.id" class="todo-action-group" v-show="slotProps.todo.status == 'todo_open'">
            <a @click="renewTodo(todo)" class="todo-action hover-color-secondary" href="javascript:;">更新</a>
          </div>
        </template>
      </todo-item>
    </todo-list>  
  </template>
  <template id="settings-view-template">
    <div class="paper-container">
      <span class="font-mono">Settings</span>
      <form class="td-form" @submit.prevent="saveSettings($event)">
        <div class="td-form-item">
          <label for="">Timezone</label>
          <input type="text" v-model="form.tz" required />
        </div>
        <div class="td-form-item">
          <label for="">Theme Color</label>
          <input type="text" v-model="form.themeColor" required />
        </div>
        <div class="td-form-item">
          <label for="">Language</label>
          <select name="lang" id="form-lang" v-model="form.lang">
            <option value="en_US">English (en_US)</option>
            <option value="zh_CN">中文简体 (zh_CN)</option>
          </select>
        </div>
        <div class="td-form-item">
          <button type="submit" class="td-button">保存</button>
          <button @click.prevent="reload" class="td-button">取消</button>
        </div>
      </form>
    </div>
  </template>
  <template id="profile-view-template">
    <div class="paper-container">
      <span class="font-mono">Profile</span>
      <a href="javascript:;" @click="logout()">logout</a>
    </div>
  </template>
  <template id="tudou-view-template">
    <div class="paper-container">
      <pre>

        Tudou Paper v0.1
        ================================================

        Thanks

        * Gin         https://gin-gonic.com/
                      https://github.com/gin-gonic/gin

        * Gorm        https://gorm.io/
                      https://github.com/jinzhu/gorm

        * Vue.js      https://vuejs.org
                      https://github.com/vuejs/vue

        * Cloudflare  https://cloudflare.com
        ================================================
      </pre>
    </div>
  </template>
  <template id="icon-bi-check">
    <svg class="bi bi-check" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" d="M13.854 3.646a.5.5 0 010 .708l-7 7a.5.5 0 01-.708 0l-3.5-3.5a.5.5 0 11.708-.708L6.5 10.293l6.646-6.647a.5.5 0 01.708 0z" clip-rule="evenodd"/>
    </svg>
  </template>
  <template id="icon-bi-right">
    <svg class="bi bi-caret-right" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" d="M6 12.796L11.481 8 6 3.204v9.592zm.659.753l5.48-4.796a1 1 0 000-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 001.659.753z" clip-rule="evenodd"/>
    </svg>
  </template>
  <template id="icon-bi-left">
    <svg class="bi bi-caret-left" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" d="M10 12.796L4.519 8 10 3.204v9.592zm-.659.753l-5.48-4.796a1 1 0 010-1.506l5.48-4.796A1 1 0 0111 3.204v9.592a1 1 0 01-1.659.753z" clip-rule="evenodd"/>
    </svg>
  </template>
  <template id="icon-bi-dash">
    <svg class="bi bi-dash" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" d="M3.5 8a.5.5 0 01.5-.5h8a.5.5 0 010 1H4a.5.5 0 01-.5-.5z" clip-rule="evenodd"/>
    </svg>
  </template>
  <script>
    (function () {
      window.addEventListener('DOMContentLoaded', function() {
        const token = window.localStorage.getItem('token') ?? null;
        if (!token) {
          window.history.replaceState(null, 'login', '/login?next=/');
          document.location.reload();
          return;
        } 
        const TudouView = 'tudou-view';
        const TodayView = 'today-view';
        const TomorrawView = 'tomorraw-view';
        const OverdueView = 'overdue-view';
        const SettingsView = 'settings-view';
        const ProfileView = 'profile-view';
        const EventBus = new Vue();
        Vue.mixin({
          methods: {
            reload: () => EventBus.$emit('changed'),
            navigate: viewName => EventBus.$emit('viewChange', viewName),
            login() {
              window.history.replaceState(null, 'login', '/login?next=/');
              document.location.reload();
            },
            logout() {
              localStorage.removeItem('token');
              window.history.replaceState(null, 'login', '/login?next=/');
              document.location.reload();
            },
          },
        });
        Vue.component('icon-check', {
          template: '#icon-bi-check',
        });
        Vue.component('icon-right', {
          template: '#icon-bi-right',
        });
        Vue.component('icon-left', {
          template: '#icon-bi-left',
        });
        Vue.component('icon-dash', {
          template: '#icon-bi-dash',
        });        
        Vue.component('todo-list', {
          template: '#todo-list-template',
        });
        Vue.component('todo-item', {
          template: '#todo-item-template',
          props: ['todo'],
          methods: { },
        });
        Vue.component('todo-item-form', {
          props: ['form'],
          template: '#todo-item-form-template',
        });
        Vue.component('today-view', {
          template: '#today-view-template',
          props: ['todos'],
          data() {
            return {
              form: {
                content: '',
                id: null,
              },
            };
          },
          methods: {
            async pushTodo(todo) {
              await pushTodo(todo.id);
              await this.reload();
            },
            async finishTodo(todo) {
              await finishTodo(todo.id);
              await this.reload();
            },
            async cancelTodo(todo) {
              await cancelTodo(todo.id);
              await this.reload();
            },
            async updateTodo() {
              await updateTodo(this.form.id, this.form.content);
              await this.reload();
              this.resetForm();
            },
            async cloneTodo(todo) {
              await cloneTodo(todo.id);
              await this.reload();
              this.navigate(TomorrawView);
            },
            editTodo(todo) {
              this.form = { content: todo.event.content, id: todo.id };
            },
            resetForm() {
              this.form = { content: '', id: null, };
            },
          },
        });
        Vue.component('tomorraw-view', {
          template: '#tomorraw-view-template',
          props: ['todos'],
          data() { return { form: { content: '', id: null, }, }; },
          methods: {
            async pullTodo(todo) {
              await pullTodo(todo.id);
              await this.reload();
            },
            async cancelTodo(todo) {
              await cancelTodo(todo.id);
              await this.reload();
            },
            async removeTodo(todo) {
              await removeTodo(todo.id);
              await this.reload();
            },
            async createTodo() {
              await createTodo(this.form.content);
              await this.reload();
              this.resetForm();
            },
            async updateTodo() {
              await updateTodo(this.form.id, this.form.content);
              await this.reload();
              this.resetForm();
            },
            editTodo(todo) {
              this.form = { content: todo.event.content, id: todo.id };
            },
            resetForm() {
              this.form = { content: '', id: null, };
            },
          }
        });
        Vue.component('overdue-view', {
          template: '#overdue-view-template',
          props: ['todos'],
          methods: {
            async renewTodo(todo) {
              await renewTodo(todo.id);
              await this.reload();
            },
          },
        });
        Vue.component('settings-view', {
          template: '#settings-view-template',
          created() {
            this.reload();
          },
          data() {
            return { form: {}, };
          },
          methods: {
            resetForm() {
              this.form = {
                tz: 'UTC',
                lang: 'zh_CN',
                gameMode: false,
                themeColor: 'teal',
              };
            },
            async reload() {
              await this.getSettings();
            },
            async getSettings() {
              this.form = await getSettings();
            },
            async saveSettings() {
              await updateSettings(this.form);
              await this.reload();
            },
          },
        });
        Vue.component('profile-view', {
          template: '#profile-view-template',
        });
        Vue.component('tudou-view', {
          template: '#tudou-view-template',
        });
        new Vue({
          el: '#app',
          data: {
            user: {},
            todayTodos: [],
            tomorrawTodos: [],
            overdueTodos: [],
            form: { id: null, content: '' },

            view: TodayView,
            TudouView,
            TodayView,
            TomorrawView,
            OverdueView,
            SettingsView,
            ProfileView,
          },
          created() {
            this.reload();
            EventBus.$on('changed', () => {
              this.reload();
            });
            EventBus.$on('viewChange', viewName => {
              this.view = viewName;
            });
          },
          methods: {
            reload() {
              this.getTodos();
              this.getProfile();
            },
            async saveTodo() {

            },
            async getTodos() {
              const { todayTodos, tomorrawTodos, overdueTodos, } = await getTodos();
              this.todayTodos = todayTodos;
              this.tomorrawTodos = tomorrawTodos;
              this.overdueTodos = overdueTodos;
            },
            async getProfile() {
              const user = await getProfile();
              this.user = user;
              this.settings = user.settings || {};
            },
            async createTodo() {
              const { content } = this.form;
              await createTodo(content);
              await this.reload();
              await this.resetForm();
            },
            async updateTodo() {
              const { id, content } = this.form;
              await updateTodo(id, content);
              await this.reload();
              await this.resetForm();
            },
          },
        });
      });
      async function getTodos() {
        const resp = await request('/api/my/todos');
        const data = await resp.json();
        const {
          today,
          tomorraw,
        } = data;
        const todayTodos = data[today];
        const tomorrawTodos = data[tomorraw];
        const overdueTodos = data['overdue'];
      
        return {
          today,
          todayTodos: todayTodos.map(todo => {
            const time = todo.event?.content?.match(/@(\d+\:\d+)/)?.[1] ?? (99999999 + todo.id).toString();
            return {
              ...todo,
              index: +time.replace(':', ''),
            };
          }).sort((a, b) => a.index - b.index),
          tomorraw,
          tomorrawTodos: tomorrawTodos.filter(todo => todo.status === 'todo_open'),
          overdueTodos,
        };
      }
      async function getSettings() {
        const resp = await request(`/api/my/settings`);
        const data = await resp.json();
        const { settings } = data;
        return settings;
      }
      async function getProfile() {
        const resp = await request('/api/my/profile');
        const data = await resp.json();
        const { user } = data;
        return user;
      }
      async function createTodo(content) {
        const time = (content?.match(/@(\d+:\d+)\s/)?.[1] ?? '23:59').padStart(5, '0');
        const resp = await request('/api/a/todo.create', {
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content, time, }),
          method: 'POST',
        });
      }
      async function updateTodo(id, content) {
        const time = (content?.match(/@(\d+:\d+)\s/)?.[1] ?? '23:59').padStart(5, '0');
        const resp = await request('/api/a/todo.update', {
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id, content, time, }),
          method: 'POST',
        });
      }
      async function pullTodo(id) {
        const resp = await request(`/api/a/todo.pull?id=${id}`, {
          method: 'POST',
        });
      }
      async function pushTodo(id) {
        const resp = await request(`/api/a/todo.push?id=${id}`, {
          method: 'POST',
        });
      }
      async function cancelTodo(id) {
        const resp = await request(`/api/a/todo.cancel?id=${id}`, {
          method: 'POST',
        });
      }
      async function finishTodo(id) {
        const resp = await request(`/api/a/todo.finish?id=${id}`, {
          method: 'POST',
        });
      }
      async function removeTodo(id) {
        const resp = await request(`/api/a/todo.remove?id=${id}`, {
          method: 'POST',
        });
      }
      async function renewTodo(id) {
        const resp = await request(`/api/a/todo.renew?id=${id}`, {
          method: 'POST',
        });
      }
      async function cloneTodo(id) {
        const resp = await request(`/api/a/todo.clone?id=${id}`, {
          method: 'POST',
        });
      }
      async function updateSettings(values) {
        const resp = await request(`/api/a/settings.update`, {
          method: 'POST',
          body: JSON.stringify(values),
          headers: {
            'Content-Type': 'application/json',
          },
        });
      }

      function request(url, data) {
        return fetch(url, {
          ...data,
          headers: {
            ...data?.headers ?? null,
            Authorization: `Bearer ${ localStorage.getItem('token') ?? '' }`,
          },
        });
      }
    })();
  </script>
</body>

</html>